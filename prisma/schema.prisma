generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// #region ENUMS
enum Role {
  CUSTOMER
  ADMIN
  COURIER
  VENUE_OWNER
  VENUE_STAFF
  EVENT_OWNER
  COMMUNITY_OWNER
}

enum BookingStatus {
  PENDING
  PAID
  CANCELLED
  COMPLETED
}

enum TransactionStatus {
  PENDING
  SUCCESS
  FAILED
  REFUNDED
  EXPIRED
}

enum TransactionType {
  TOPUP
  DEDUCTION
  FEE
  BOOKING
  WITHDRAW
  REFUND
  REWARD
  COMMISSION
  EVENT
}

enum PointActivityType {
  REGISTER
  BOOKING
  EVENT_PURCHASE
  REVIEW
  PAYMENT
  PROMO
  REFUND
  ADMIN_GRANT
}

enum InvoiceStatus {
  PENDING
  PAID
  CANCELLED
  REFUNDED
  EXPIRED
}

enum WithdrawStatus {
  PENDING
  APPROVED
  REJECTED
  PAID
}

enum EventStatus {
  UPCOMING
  ONGOING
  FINISHED
  CANCELLED
}

enum TicketStatus {
  ACTIVE
  USED
  EXPIRED
  REFUNDED
}

enum EventOrderStatus {
  PENDING
  PAID
  CANCELLED
  EXPIRED
}

enum PublicPlaceType {
  TOURISM
  HOSPITAL
  SCHOOL
  PARK
  MALL
  TERMINAL
  OTHER
}

enum UnitType {
  FIELD
  TABLE
  ROOM
  COURT
}

enum BookingType {
  TIME
  SESSION
  NONE
}

enum NewsStatus {
  AUTO
  MANUAL
  FAILED
}

enum CourierStatus {
  OFFLINE
  ONLINE
  ON_DELIVERY
  SUSPENDED
}

enum VehicleType {
  MOTORCYCLE
  CAR
  BICYCLE
  WALKING
}

enum DeliveryStatus {
  PENDING
  ASSIGNED
  PICKED_UP
  ON_THE_WAY
  DELIVERED
  CANCELLED
}

enum StaffPosition {
  MANAGER
  CASHIER
  RECEPTIONIST
  CLEANING
  SECURITY
  TECHNICIAN
  OTHER
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum CommunityMemberStatus {
  PENDING
  APPROVED
  REJECTED
}

enum CommunityMemberRole {
  OWNER
  ADMIN
  MEMBER
}

enum CommunityEventType {
  MEETUP
  ONLINE
  ANNOUNCEMENT
  WORKSHOP
  OTHER
}

enum CommunityEventStatus {
  UPCOMING
  ONGOING
  FINISHED
  CANCELLED
}

enum CommentEntityType {
  COMMUNITY
  EVENT
  PUBLIC_PLACE
}

enum TaskEntityType {
  COMMUNITY
  EVENT
  PUBLIC_PLACE
}

enum TaskType {
  ATTEND_EVENT
  CHECK_IN
  RATE_PLACE
  CUSTOM
}

enum TaskExecutionStatus {
  PENDING
  COMPLETED
  FAILED
}

// #regionUSER & AUTH
model User {
  id               String     @id @default(uuid())
  name             String
  username         String?
  email            String     @unique
  password         String
  address          String?
  roles            UserRole[]
  phone            String?
  photo            String?
  googleId         String?    @unique
  isVerified       Boolean    @default(false)
  transactionPin   String?
  pinFailedCount   Int        @default(0)
  pinLockedUntil   DateTime?
  biometricEnabled Boolean    @default(false)
  devices          Device[]
  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @default(now()) @updatedAt

  // Relations
  bookings         Booking[]
  transactions     Transaction[]
  notifications    Notification[]
  locations        LocationTracking[]
  logs             Log[]
  balance          UserBalance?
  points           Point[]
  likedVenues      LikeVenue[]
  venueImpressions VenueImpression[]

  likedEvents  LikeEvent[]
  eventReviews ReviewEvent[]
  eventOrders  EventOrder[]
  eventTickets EventTicket[]

  likedPlaces      LikePublicPlace[]
  placeReviews     ReviewPublicPlace[]
  placeImpressions PublicPlaceImpression[]

  courier         Courier?
  deliveries      Delivery[]
  newsImpressions NewsImpression[]
  newsComments    NewsComment[]
  courierRatings  CourierRating[]

  ownedCommunities     Community[]
  communityMemberships CommunityMember[]
  communityPosts       CommunityPost[]
  communityReactions   CommunityReaction[]
  twibbons             CommunityTwibbon[]

  communityEvents       CommunityEvent[]
  comments              Comment[]
  commentLikes          CommentLike[]
  commentReports        CommentReport[]
  taskExecutions        TaskExecution[]
  communityPostMentions CommunityPostMention[]
  events                Event[]

  @@index([email])
  @@index([phone])
  @@index([createdAt])
}

model UserRole {
  id     String @id @default(uuid())
  userId String
  role   Role

  venueId String?
  eventId String?

  isActive   Boolean  @default(true)
  assignedAt DateTime @default(now())

  user  User   @relation(fields: [userId], references: [id])
  venue Venue? @relation(fields: [venueId], references: [id])
  event Event? @relation(fields: [eventId], references: [id])

  @@unique([userId, role], map: "unique_global_role")
  @@unique([userId, role, venueId], map: "unique_venue_role")
  @@unique([userId, role, eventId], map: "unique_event_role")
  @@index([userId])
  @@index([role])
  @@index([venueId])
  @@index([eventId])
}

model UserBalance {
  id        String   @id @default(uuid())
  userId    String   @unique
  balance   Float    @default(0)
  updatedAt DateTime @default(now()) @updatedAt

  user User @relation(fields: [userId], references: [id])
}

model Device {
  id           String    @id @default(uuid())
  userId       String?
  venueId      String?
  token        String
  expoToken    String
  platform     String?
  osName       String?
  buildId      String?
  osVersion    String?
  deviceModel  String?
  isOnline     Boolean   @default(false)
  lastActiveAt DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  user  User?  @relation(fields: [userId], references: [id])
  venue Venue? @relation(fields: [venueId], references: [id])

  @@unique([token, userId])
  @@index([venueId])
}

model LocationTracking {
  id        String   @id @default(uuid())
  userId    String
  latitude  Float
  longitude Float
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  user User @relation(fields: [userId], references: [id])

  @@index([userId, createdAt])
}

model Log {
  id          String   @id @default(uuid())
  userId      String?
  action      String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now()) @updatedAt

  user User? @relation(fields: [userId], references: [id])
}

// #region VENUE CORE
model Venue {
  id          String   @id @default(uuid())
  name        String
  address     String
  city        String
  province    String
  description String
  latitude    Float?
  longitude   Float?
  image       String?
  gallery     String[] @default([])
  isActive    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now()) @updatedAt

  services VenueService[]
  units    VenueUnit[]

  // Relations
  devices          Device[]
  floors           Floor[]
  bookings         Booking[]
  operationalHours OperationalHour[]
  invitation       InvitationKey[]
  balance          VenueBalance?
  transactions     Transaction[]
  withdrawRequests WithdrawRequest[]
  likes            LikeVenue[]
  impressions      VenueImpression[]
  events           Event[]
  menus            Menu[]
  staffs           VenueStaff[]
  userRoles        UserRole[]

  @@index([city])
  @@index([province])
  @@index([isActive])
  @@index([createdAt])
}

model VenueStaff {
  id      String @id @default(uuid())
  venueId String

  name     String
  phone    String?
  position StaffPosition @default(OTHER)

  gender           Gender?
  birthDate        DateTime?
  address          String?
  emergencyContact String?
  photo            String?
  note             String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  venue Venue @relation(fields: [venueId], references: [id])

  @@index([venueId])
}

model VenueCategory {
  id       String  @id @default(uuid())
  name     String // Sport, Food, Entertainment, dll
  code     String  @unique
  icon     String?
  isActive Boolean @default(true)

  subCategories VenueSubCategory[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isActive])
}

model VenueSubCategory {
  id            String  @id @default(uuid())
  categoryId    String
  name          String // Mini Soccer, Cafe, Billiard
  code          String  @unique
  description   String?
  defaultConfig Json // TEMPLATE CONFIG
  isActive      Boolean @default(true)

  category VenueCategory  @relation(fields: [categoryId], references: [id])
  services VenueService[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([categoryId])
  @@index([isActive])
}

model VenueService {
  id            String @id @default(uuid())
  venueId       String
  subCategoryId String

  config      Json
  image       String?
  unitType    UnitType?
  bookingType BookingType?

  isActive Boolean @default(true)

  venue       Venue            @relation(fields: [venueId], references: [id])
  subCategory VenueSubCategory @relation(fields: [subCategoryId], references: [id])

  units    VenueUnit[]
  menus    Menu[]
  bookings Booking[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([venueId, subCategoryId])
  @@index([venueId])
  @@index([subCategoryId])
  @@index([isActive])
}

model InvitationKey {
  id    String @id @default(uuid())
  key   String @unique
  email String
  role  Role

  venueId     String?
  eventId     String?
  communityId String?

  usedAt    DateTime?
  expiresAt DateTime?

  venue     Venue?     @relation(fields: [venueId], references: [id])
  event     Event?     @relation(fields: [eventId], references: [id])
  community Community? @relation(fields: [communityId], references: [id])
}

model VenueBalance {
  id        String   @id @default(uuid())
  venueId   String   @unique
  balance   Float    @default(0)
  updatedAt DateTime @default(now()) @updatedAt

  venue Venue @relation(fields: [venueId], references: [id])
}

// #region VENUE STRUCTURE
model Floor {
  id      String @id @default(uuid())
  name    String
  level   Int?
  venueId String
  venue   Venue  @relation(fields: [venueId], references: [id])

  units VenueUnit[]
}

model VenueUnit {
  id        String  @id @default(uuid())
  venueId   String
  serviceId String
  floorId   String?

  name     String
  type     UnitType
  price    Float
  isActive Boolean  @default(true)

  floor   Floor?       @relation(fields: [floorId], references: [id])
  venue   Venue        @relation(fields: [venueId], references: [id])
  service VenueService @relation(fields: [serviceId], references: [id])

  booking Booking[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([venueId])
  @@index([serviceId])
  @@index([isActive])
}

model OperationalHour {
  id        String @id @default(uuid())
  venueId   String
  dayOfWeek Int
  opensAt   Int
  closesAt  Int

  venue Venue @relation(fields: [venueId], references: [id])

  @@index([venueId, dayOfWeek])
}

// #region BOOKING & ORDER
model Booking {
  id         String        @id @default(uuid())
  userId     String
  venueId    String
  serviceId  String
  unitId     String?
  startTime  DateTime
  endTime    DateTime
  totalPrice Float
  status     BookingStatus @default(PENDING)
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @default(now()) @updatedAt

  user       User         @relation(fields: [userId], references: [id])
  venue      Venue        @relation(fields: [venueId], references: [id])
  service    VenueService @relation(fields: [serviceId], references: [id])
  unit       VenueUnit?   @relation(fields: [unitId], references: [id])
  orderItems OrderItem[]
  review     Review?
  invoice    Invoice?
  delivery   Delivery?

  @@index([userId])
  @@index([venueId])
  @@index([serviceId])
  @@index([status])
  @@index([startTime, endTime])
  @@index([venueId, startTime, endTime])
}

model Menu {
  id      String @id @default(uuid())
  venueId String

  name        String
  price       Float
  category    String
  image       String?
  isAvailable Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now()) @updatedAt

  venue          Venue         @relation(fields: [venueId], references: [id])
  orderItems     OrderItem[]
  venueService   VenueService? @relation(fields: [venueServiceId], references: [id])
  venueServiceId String?

  @@index([venueId])
}

model OrderItem {
  id        String   @id @default(uuid())
  bookingId String
  menuId    String
  quantity  Int
  subtotal  Float
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  booking Booking @relation(fields: [bookingId], references: [id])
  menu    Menu    @relation(fields: [menuId], references: [id])

  @@index([bookingId])
  @@index([menuId])
}

model Review {
  id        String   @id @default(uuid())
  bookingId String   @unique
  rating    Float
  comment   String?
  image     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  booking Booking @relation(fields: [bookingId], references: [id])

  @@index([rating])
  @@index([bookingId])
}

// #region FINANCIAL / PAYMENT
model Transaction {
  id           String             @id @default(uuid())
  userId       String?
  venueId      String?
  eventOrderId String?
  amount       Float
  type         TransactionType
  reference    String?
  vaNumber     String?
  qrisUrl      String?
  paymentCode  String?
  bankCode     String?
  orderId      String?
  expiredAt    DateTime?
  status       TransactionStatus? @default(PENDING)

  idempotencyKey String?

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  user       User?       @relation(fields: [userId], references: [id])
  venue      Venue?      @relation(fields: [venueId], references: [id])
  eventOrder EventOrder? @relation(fields: [eventOrderId], references: [id])

  @@unique([idempotencyKey])
  @@index([userId])
  @@index([venueId])
  @@index([status])
  @@index([type])
  @@index([createdAt])
}

model Invoice {
  id           String  @id @default(uuid())
  bookingId    String? @unique
  eventOrderId String? @unique

  invoiceNumber String        @unique
  amount        Float
  status        InvoiceStatus @default(PENDING)
  paymentMethod String?
  issuedAt      DateTime      @default(now())
  paidAt        DateTime?
  cancelledAt   DateTime?
  expiredAt     DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  booking    Booking?    @relation(fields: [bookingId], references: [id])
  eventOrder EventOrder? @relation(fields: [eventOrderId], references: [id])

  @@index([status])
  @@index([issuedAt])
  @@index([paidAt])
}

model WithdrawRequest {
  id             String         @id @default(uuid())
  venueId        String
  amount         Float
  fee            Float          @default(0)
  netAmount      Float
  status         WithdrawStatus @default(PENDING)
  withdrawNumber String         @unique

  bankCode    String
  bankAccount String
  accountName String
  note        String?

  requestedAt DateTime  @default(now())
  approvedAt  DateTime?
  paidAt      DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  venue Venue @relation(fields: [venueId], references: [id])

  @@index([venueId, status])
  @@index([status])
}

model PlatformBalance {
  id        String   @id @default(uuid())
  balance   Float    @default(0)
  updatedAt DateTime @default(now()) @updatedAt
}

// #region POINTS SYSTEM
model Point {
  id        String            @id @default(uuid())
  userId    String
  activity  PointActivityType
  points    Int
  reference String? // id dari booking, transaction, dsb
  createdAt DateTime          @default(now())

  user User @relation(fields: [userId], references: [id])
}

// #region VENUE INTERACTIONS
model LikeVenue {
  id        String   @id @default(uuid())
  userId    String
  venueId   String
  createdAt DateTime @default(now())

  user  User  @relation(fields: [userId], references: [id])
  venue Venue @relation(fields: [venueId], references: [id])

  @@unique([userId, venueId])
  @@index([userId])
  @@index([venueId])
}

model VenueImpression {
  id        String   @id @default(uuid())
  venueId   String
  userId    String?
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())

  venue Venue @relation(fields: [venueId], references: [id])
  user  User? @relation(fields: [userId], references: [id])

  @@index([venueId, createdAt])
}

// #region EVENTS INTERACTION
model ReviewEvent {
  id        String   @id @default(uuid())
  eventId   String
  userId    String
  rating    Float
  comment   String?
  image     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  event Event @relation(fields: [eventId], references: [id])
  user  User  @relation(fields: [userId], references: [id])

  @@unique([userId, eventId])
}

model LikeEvent {
  id        String   @id @default(uuid())
  userId    String
  eventId   String
  createdAt DateTime @default(now())

  user  User  @relation(fields: [userId], references: [id])
  event Event @relation(fields: [eventId], references: [id])

  @@unique([userId, eventId])
  @@index([userId])
  @@index([eventId])
}

// #region PUBLIC PLACE INTERACTIONS
model ReviewPublicPlace {
  id        String   @id @default(uuid())
  userId    String
  placeId   String
  rating    Float
  comment   String?
  image     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  user  User        @relation(fields: [userId], references: [id])
  place PublicPlace @relation(fields: [placeId], references: [id])

  @@unique([userId, placeId])
}

model LikePublicPlace {
  id        String   @id @default(uuid())
  userId    String
  placeId   String
  createdAt DateTime @default(now())

  user  User        @relation(fields: [userId], references: [id])
  place PublicPlace @relation(fields: [placeId], references: [id])

  @@unique([userId, placeId])
  @@index([userId])
  @@index([placeId])
}

model PublicPlaceImpression {
  id        String   @id @default(uuid())
  placeId   String
  userId    String?
  createdAt DateTime @default(now())

  place PublicPlace @relation(fields: [placeId], references: [id])
  user  User?       @relation(fields: [userId], references: [id])

  @@index([placeId, createdAt])
}

// #region EVENTS & PUBLIC PLACES CORE

model Event {
  id          String      @id @default(uuid())
  venueId     String?
  communityId String?
  name        String
  description String
  image       String?
  startAt     DateTime
  endAt       DateTime
  capacity    Int?
  location    String
  status      EventStatus @default(UPCOMING)
  isActive    Boolean     @default(true)
  isCommunity Boolean     @default(false)
  isVenue     Boolean     @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  venue     Venue?     @relation(fields: [venueId], references: [id])
  community Community? @relation(fields: [communityId], references: [id])

  reviews ReviewEvent[]
  likes   LikeEvent[]

  ticketTypes    EventTicketType[]
  orders         EventOrder[]
  tickets        EventTicket[]
  userRoles      UserRole[]
  invitationKeys InvitationKey[]
  user           User?             @relation(fields: [userId], references: [id])
  userId         String?

  @@index([venueId])
  @@index([status])
  @@index([startAt, endAt])
}

model EventTicketType {
  id          String  @id @default(uuid())
  eventId     String
  name        String
  price       Float
  quota       Int
  sold        Int     @default(0)
  description String?
  isActive    Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  event   Event         @relation(fields: [eventId], references: [id])
  tickets EventTicket[]

  @@index([eventId])
}

model EventOrder {
  id      String           @id @default(uuid())
  userId  String
  eventId String
  total   Float
  status  EventOrderStatus @default(PENDING)

  idempotencyKey String?   @unique
  expiresAt      DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user         User          @relation(fields: [userId], references: [id])
  event        Event         @relation(fields: [eventId], references: [id])
  tickets      EventTicket[]
  invoice      Invoice?
  transactions Transaction[]

  @@index([userId])
  @@index([eventId])
  @@index([status])
}

model EventTicket {
  id           String @id @default(uuid())
  ticketTypeId String
  eventId      String
  userId       String
  orderId      String

  qrCode String       @unique
  status TicketStatus @default(ACTIVE)
  usedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  user       User            @relation(fields: [userId], references: [id])
  event      Event           @relation(fields: [eventId], references: [id])
  order      EventOrder      @relation(fields: [orderId], references: [id])
  ticketType EventTicketType @relation(fields: [ticketTypeId], references: [id])

  @@index([userId])
  @@index([eventId])
  @@index([status])
}

model PublicPlace {
  id          String          @id @default(uuid())
  name        String
  type        PublicPlaceType
  address     String
  description String?
  latitude    Float?
  longitude   Float?
  image       String?
  gallery     String[]        @default([])
  isActive    Boolean         @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  reviews     ReviewPublicPlace[]
  likes       LikePublicPlace[]
  impressions PublicPlaceImpression[]
}

// #region NOTIFICATIONS
model Notification {
  id        String   @id @default(uuid())
  userId    String?
  venueId   String?
  adminOnly Boolean? @default(false)
  title     String
  message   String
  type      String?
  image     String?
  isRead    Boolean  @default(false)
  isGlobal  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  user User? @relation(fields: [userId], references: [id])
}

// #region NEWS
model News {
  id          String     @id @default(uuid())
  sourceUrl   String
  title       String
  description String
  image       String?
  source      String
  status      NewsStatus
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @default(now()) @updatedAt

  newsImpressions NewsImpression[]
  newsComments    NewsComment[]

  @@index([status])
  @@index([createdAt])
}

model NewsImpression {
  id          String   @id @default(uuid())
  newsId      String
  userId      String
  ipAddress   String?
  userAgent   String?
  isAnonymous Boolean  @default(false)
  createdAt   DateTime @default(now())

  news News  @relation(fields: [newsId], references: [id])
  user User? @relation(fields: [userId], references: [id])

  @@index([newsId, createdAt])
}

model NewsComment {
  id        String   @id @default(uuid())
  newsId    String
  userId    String
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  news News @relation(fields: [newsId], references: [id])
  user User @relation(fields: [userId], references: [id])

  @@index([newsId])
  @@index([userId])
}

// #region COURIER CORE
model Courier {
  id     String        @id @default(uuid())
  userId String        @unique
  status CourierStatus @default(OFFLINE)

  vehicleType VehicleType
  plateNumber String?
  photo       String?

  rating     Float @default(0)
  totalTrips Int   @default(0)

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  user User @relation(fields: [userId], references: [id])

  deliveries Delivery[]
  locations  CourierLocation[]

  courierRatings          CourierRating[]
  courierAvailabilityLogs CourierAvailabilityLog[]
  courierEarnings         CourierEarnings[]

  @@index([status])
  @@index([vehicleType])
}

model Delivery {
  id        String  @id @default(uuid())
  courierId String
  userId    String?
  bookingId String? @unique

  pickupAddress  String
  dropoffAddress String

  status DeliveryStatus @default(PENDING)

  assignedAt  DateTime?
  pickedUpAt  DateTime?
  deliveredAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  courier Courier  @relation(fields: [courierId], references: [id])
  user    User?    @relation(fields: [userId], references: [id])
  booking Booking? @relation(fields: [bookingId], references: [id])

  @@index([courierId, status])
  @@index([bookingId])
  @@index([status])
}

model CourierLocation {
  id        String   @id @default(uuid())
  courierId String
  latitude  Float
  longitude Float
  updatedAt DateTime @default(now()) @updatedAt

  courier Courier @relation(fields: [courierId], references: [id])

  @@index([courierId, updatedAt])
}

model CourierRating {
  id        String   @id @default(uuid())
  courierId String
  userId    String
  rating    Float
  comment   String?
  tripId    String?
  createdAt DateTime @default(now())

  courier Courier @relation(fields: [courierId], references: [id])
  user    User    @relation(fields: [userId], references: [id])

  @@index([courierId])
  @@index([userId])
}

model CourierAvailabilityLog {
  id        String        @id @default(uuid())
  courierId String
  status    CourierStatus
  note      String? // opsional, misal alasan OFFLINE / SUSPENDED
  createdAt DateTime      @default(now())

  courier Courier @relation(fields: [courierId], references: [id])

  @@index([courierId, createdAt])
}

model CourierEarnings {
  id            String   @id @default(uuid())
  courierId     String
  periodStart   DateTime // awal periode penghitungan
  periodEnd     DateTime // akhir periode penghitungan
  totalTrips    Int      @default(0)
  totalEarnings Float    @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @default(now()) @updatedAt

  courier Courier @relation(fields: [courierId], references: [id])

  @@index([courierId, periodStart, periodEnd])
}

// #region COMMUNITY
model Community {
  id           String   @id @default(uuid())
  name         String
  description  String?
  image        String?
  ownerId      String?
  waContact    String?
  phoneContact String?
  emailContact String?
  basecamp     String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  owner   User?             @relation(fields: [ownerId], references: [id])
  members CommunityMember[]
  posts   CommunityPost[]

  hostedEvents   Event[] // Event besar / ticketing
  internalEvents CommunityEvent[]

  twibbons                     CommunityTwibbon[]
  invitation                   InvitationKey[]
  communityEventCollaborations CommunityEventCollaboration[]
  task                         Task[]

  @@index([ownerId])
  @@index([createdAt])
}

model CommunityMember {
  id          String                @id @default(uuid())
  communityId String
  userId      String
  role        CommunityMemberRole   @default(MEMBER)
  status      CommunityMemberStatus @default(PENDING)
  joinedAt    DateTime              @default(now())

  community Community @relation(fields: [communityId], references: [id])
  user      User      @relation(fields: [userId], references: [id])

  @@unique([communityId, userId])
  @@index([communityId])
  @@index([userId])
}

model CommunityPost {
  id          String   @id @default(uuid())
  communityId String
  adminId     String // harus admin komunitas
  content     String
  image       String?
  link        String? // optional link/file
  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now()) @updatedAt

  community             Community              @relation(fields: [communityId], references: [id])
  admin                 User                   @relation(fields: [adminId], references: [id])
  reactions             CommunityReaction[]
  communityPostMentions CommunityPostMention[]

  @@index([communityId])
  @@index([adminId])
}

model CommunityPostMention {
  id        String   @id @default(uuid())
  postId    String
  userId    String
  createdAt DateTime @default(now())

  post CommunityPost @relation(fields: [postId], references: [id])
  user User          @relation(fields: [userId], references: [id])

  @@unique([postId, userId]) // anti double tag
}

model CommunityReaction {
  id        String   @id @default(uuid())
  postId    String
  userId    String
  type      String // misal "LIKE" atau emoji
  createdAt DateTime @default(now())

  post CommunityPost @relation(fields: [postId], references: [id])
  user User          @relation(fields: [userId], references: [id])

  @@unique([postId, userId])
  @@index([postId])
  @@index([userId])
}

model CommunityEvent {
  id          String @id @default(uuid())
  communityId String
  createdById String

  title       String
  description String?
  image       String?
  type        CommunityEventType @default(MEETUP)

  startAt DateTime
  endAt   DateTime?

  location    String?
  meetingLink String?

  status   CommunityEventStatus @default(UPCOMING)
  isPublic Boolean              @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  community Community @relation(fields: [communityId], references: [id])
  createdBy User      @relation(fields: [createdById], references: [id])

  collaborations CommunityEventCollaboration[]

  @@index([communityId])
  @@index([startAt])
  @@index([status])
}

model CommunityTwibbon {
  id          String @id @default(uuid())
  communityId String
  createdById String

  title        String
  description  String?
  frameImage   String // PNG transparan
  previewImage String?
  isActive     Boolean @default(true)

  startAt DateTime?
  endAt   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  community Community @relation(fields: [communityId], references: [id])
  createdBy User      @relation(fields: [createdById], references: [id])

  @@index([communityId])
  @@index([isActive])
}

model CommunityEventCollaboration {
  id          String @id @default(uuid())
  eventId     String
  communityId String
  role        String @default("CO_HOST")

  createdAt DateTime @default(now())

  event     CommunityEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)
  community Community      @relation(fields: [communityId], references: [id])

  @@unique([eventId, communityId])
}

model Comment {
  id      String @id @default(uuid())
  userId  String
  content String

  entityType CommentEntityType
  entityId   String

  parentId String?

  likeCount   Int @default(0)
  reportCount Int @default(0)

  isHidden  Boolean @default(false)
  isDeleted Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user           User            @relation(fields: [userId], references: [id])
  parent         Comment?        @relation("CommentReply", fields: [parentId], references: [id])
  replies        Comment[]       @relation("CommentReply")
  commentLikes   CommentLike[]
  commentReports CommentReport[]

  @@index([entityType, entityId])
}

model CommentLike {
  id        String @id @default(uuid())
  commentId String
  userId    String

  createdAt DateTime @default(now())

  comment Comment @relation(fields: [commentId], references: [id])
  user    User    @relation(fields: [userId], references: [id])

  @@unique([commentId, userId])
}

model CommentReport {
  id        String @id @default(uuid())
  commentId String
  userId    String
  reason    String

  createdAt DateTime @default(now())

  comment Comment @relation(fields: [commentId], references: [id])
  user    User    @relation(fields: [userId], references: [id])

  @@unique([commentId, userId])
}

model UserPresenceSnapshot {
  id        String   @id @default(uuid())
  userId    String
  context   String
  contextId String?
  lastSeen  DateTime

  @@index([context, contextId])
}

model Task {
  id String @id @default(uuid())

  entityType  TaskEntityType
  entityId    String
  communityId String?

  title       String
  description String?
  type        TaskType

  rule Json // radius, qr required, dll

  requiresQr  Boolean @default(false)
  requiresGeo Boolean @default(false)

  startAt DateTime?
  endAt   DateTime?

  isActive  Boolean   @default(true)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  executions     TaskExecution[]
  community      Community?      @relation(fields: [communityId], references: [id])
  taskQrSessions TaskQrSession[]

  @@index([entityType, entityId])
}

model TaskExecution {
  id     String @id @default(uuid())
  taskId String
  userId String

  status TaskExecutionStatus @default(PENDING)

  qrSessionId String?
  latitude    Float?
  longitude   Float?

  proof       Json?
  completedAt DateTime?

  createdAt DateTime @default(now())

  task Task @relation(fields: [taskId], references: [id])
  user User @relation(fields: [userId], references: [id])

  @@unique([taskId, userId])
}

model TaskQrSession {
  id     String @id @default(uuid())
  taskId String

  token     String   @unique
  expiresAt DateTime
  isActive  Boolean  @default(true)

  createdAt DateTime @default(now())

  task Task @relation(fields: [taskId], references: [id])

  @@index([taskId])
  @@index([expiresAt])
}
