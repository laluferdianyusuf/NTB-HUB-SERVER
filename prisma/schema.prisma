generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// #region ENUMS
enum Role {
  CUSTOMER
  ADMIN
}

enum VenueType {
  BILLIARD
  MINI_SOCCER
  CAFE
  UNKNOWN
}

enum TableStatus {
  AVAILABLE
  BOOKED
  MAINTENANCE
}

enum BookingStatus {
  PENDING
  PAID
  CANCELLED
  COMPLETED
}

enum TransactionStatus {
  PENDING
  SUCCESS
  FAILED
  REFUNDED
  EXPIRED
}

enum TransactionType {
  TOPUP
  DEDUCTION
  FEE
}

enum PointActivityType {
  REGISTER
  TOPUP
  BOOKING
  REVIEW
}

enum InvoiceStatus {
  PENDING
  PAID
  CANCELLED
  REFUNDED
  EXPIRED
}

enum WithdrawStatus {
  PENDING
  APPROVED
  REJECTED
  PAID
}

enum EventStatus {
  UPCOMING
  ONGOING
  FINISHED
  CANCELLED
}

enum PublicPlaceType {
  TOURISM
  HOSPITAL
  SCHOOL
  PARK
  MALL
  TERMINAL
  OTHER
}

// #regionUSER & AUTH
model User {
  id         String   @id @default(uuid())
  name       String
  username   String?
  email      String   @unique
  password   String
  address    String?
  role       Role     @default(CUSTOMER)
  phone      String?
  photo      String?
  googleId   String?  @unique
  isVerified Boolean  @default(false)
  devices    Device[]
  createdAt  DateTime @default(now())
  updatedAt  DateTime @default(now()) @updatedAt

  // Relations
  bookings      Booking[]
  transactions  Transaction[]
  notifications Notification[]
  locations     LocationTracking[]
  logs          Log[]
  balance       UserBalance?
  points        Point[]
  likedVenues       LikeVenue[]
  venueImpressions VenueImpression[]

  likedEvents       LikeEvent[]
  eventReviews      ReviewEvent[]

  likedPlaces       LikePublicPlace[]
  placeReviews      ReviewPublicPlace[]
  placeImpressions      PublicPlaceImpression[]
}

model UserBalance {
  id        String   @id @default(uuid())
  userId    String   @unique
  balance   Float    @default(0)
  updatedAt DateTime @default(now()) @updatedAt

  user User @relation(fields: [userId], references: [id])
}

model Device {
  id          String   @id @default(uuid())
  userId      String?
  venueId     String?
  token       String
  platform    String?
  osName      String?
  buildId     String?
  osVersion   String?
  deviceModel String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user  User?  @relation(fields: [userId], references: [id])
  venue Venue? @relation(fields: [venueId], references: [id])

  @@unique([token, userId])
  @@index([venueId])
}

model LocationTracking {
  id        String   @id @default(uuid())
  userId    String
  latitude  Float
  longitude Float
  updatedAt DateTime @default(now()) @updatedAt

  user User @relation(fields: [userId], references: [id])
}

model Log {
  id          String   @id @default(uuid())
  userId      String?
  action      String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now()) @updatedAt

  user User? @relation(fields: [userId], references: [id])
}

// #region VENUE CORE
model Venue {
  id          String     @id @default(uuid())
  name        String
  type        VenueType?
  address     String
  description String
  latitude    Float?
  longitude   Float?
  image       String?
  gallery     String[]   @default([])
  isActive    Boolean    @default(false)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @default(now()) @updatedAt

  hasFloors   Boolean @default(false)
  hasTables   Boolean @default(false)
  hasMenu     Boolean @default(false)
  hasDelivery Boolean @default(false)

  // Relations
  devices          Device[]
  floors           Floor[]
  tables           Table[]
  menus            Menu[]
  bookings         Booking[]
  operationalHours OperationalHour[]
  invitation       InvitationKey?
  balance          VenueBalance?
  transactions     Transaction[]
  owner            Owner?
  withdrawRequests WithdrawRequest[]
  likes        LikeVenue[]
  impressions VenueImpression[]
  events       Event[]
}

model Owner {
  id             String   @id @default(uuid())
  venueId        String?  @unique
  name           String
  email          String?
  address        String?
  identityNumber String?
  taxNumber      String?
  image          String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @default(now()) @updatedAt

  venue Venue? @relation(fields: [venueId], references: [id])
}

model InvitationKey {
  id        String    @id @default(uuid())
  venueId   String    @unique
  key       String    @unique
  expiresAt DateTime?
  usedAt    DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @default(now()) @updatedAt

  venue Venue @relation(fields: [venueId], references: [id])
}

model VenueBalance {
  id        String   @id @default(uuid())
  venueId   String   @unique
  balance   Float    @default(0)
  updatedAt DateTime @default(now()) @updatedAt

  venue Venue @relation(fields: [venueId], references: [id])
}

// #region VENUE STRUCTURE
model Floor {
  id      String  @id @default(uuid())
  name    String
  level   Int?
  venueId String
  venue   Venue   @relation(fields: [venueId], references: [id])
  tables  Table[]
}

model Table {
  id          String      @id @default(uuid())
  tableNumber Int
  floorId     String?
  venueId     String
  status      TableStatus @default(AVAILABLE)
  image       String?
  price       Float       @default(0)
  bookingAt   DateTime?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @default(now()) @updatedAt

  floor    Floor?    @relation(fields: [floorId], references: [id])
  venue    Venue     @relation(fields: [venueId], references: [id])
  bookings Booking[]
}

model OperationalHour {
  id        String   @id @default(uuid())
  venueId   String
  dayOfWeek Int
  opensAt   DateTime
  closesAt  DateTime

  venue Venue @relation(fields: [venueId], references: [id])
}

// #region BOOKING & ORDER
model Booking {
  id         String        @id @default(uuid())
  userId     String
  venueId    String
  tableId    String
  startTime  DateTime
  endTime    DateTime
  totalPrice Float
  status     BookingStatus @default(PENDING)
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @default(now()) @updatedAt

  user       User        @relation(fields: [userId], references: [id])
  venue      Venue       @relation(fields: [venueId], references: [id])
  table      Table       @relation(fields: [tableId], references: [id])
  orderItems OrderItem[]
  review     Review?
  invoice    Invoice?
}

model Menu {
  id          String   @id @default(uuid())
  venueId     String
  name        String
  price       Float
  category    String
  image       String?
  isAvailable Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now()) @updatedAt

  venue      Venue       @relation(fields: [venueId], references: [id])
  orderItems OrderItem[]
}

model OrderItem {
  id        String   @id @default(uuid())
  bookingId String
  menuId    String
  quantity  Int
  subtotal  Float
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  booking Booking @relation(fields: [bookingId], references: [id])
  menu    Menu    @relation(fields: [menuId], references: [id])
}

model Review {
  id        String   @id @default(uuid())
  bookingId String   @unique
  rating    Float
  comment   String?
  image     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  booking Booking @relation(fields: [bookingId], references: [id])
}

// #region FINANCIAL / PAYMENT
model Transaction {
  id          String             @id @default(uuid())
  userId      String?
  venueId     String?
  amount      Float
  type        TransactionType
  reference   String?
  vaNumber    String?
  qrisUrl     String?
  paymentCode String?
  bankCode    String?
  orderId     String?
  expiredAt   DateTime?
  status      TransactionStatus? @default(PENDING)
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @default(now()) @updatedAt

  user  User?  @relation(fields: [userId], references: [id])
  venue Venue? @relation(fields: [venueId], references: [id])
}

model Invoice {
  id            String        @id @default(uuid())
  bookingId     String        @unique
  invoiceNumber String        @unique
  amount        Float
  status        InvoiceStatus @default(PENDING)
  paymentMethod String?
  issuedAt      DateTime      @default(now())
  paidAt        DateTime?
  cancelledAt   DateTime?
  expiredAt     DateTime?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @default(now()) @updatedAt

  booking Booking @relation(fields: [bookingId], references: [id])
}

model WithdrawRequest {
  id        String         @id @default(uuid())
  venueId   String
  amount    Float
  fee       Float          @default(0)
  netAmount Float
  status    WithdrawStatus @default(PENDING)

  bankCode    String
  bankAccount String
  accountName String
  note        String?

  requestedAt DateTime  @default(now())
  approvedAt  DateTime?
  paidAt      DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  venue Venue @relation(fields: [venueId], references: [id])

  @@index([venueId, status])
}

model PlatformBalance {
  id        String   @id @default(uuid())
  balance   Float    @default(0)
  updatedAt DateTime @default(now()) @updatedAt
}

// #region POINTS SYSTEM
model Point {
  id        String            @id @default(uuid())
  userId    String
  activity  PointActivityType
  points    Int
  reference String? // id dari booking, transaction, dsb
  createdAt DateTime          @default(now())

  user User @relation(fields: [userId], references: [id])
}

// #region VENUE INTERACTIONS
model LikeVenue {
  id        String   @id @default(uuid())
  userId    String
  venueId   String
  createdAt DateTime @default(now())

  user  User  @relation(fields: [userId], references: [id])
  venue Venue @relation(fields: [venueId], references: [id])

  @@unique([userId, venueId])
}

model VenueImpression {
  id        String   @id @default(uuid())
  venueId   String
  userId    String?
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())

  venue Venue @relation(fields: [venueId], references: [id])
  user  User? @relation(fields: [userId], references: [id])

  @@index([venueId, createdAt])
}

// #region EVENTS INTERACTION
model ReviewEvent {
  id        String   @id @default(uuid())
  eventId   String
  userId    String
  rating    Float
  comment   String?
  image     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  event Event @relation(fields: [eventId], references: [id])
  user  User  @relation(fields: [userId], references: [id])

  @@unique([userId, eventId])
}

model LikeEvent {
  id        String   @id @default(uuid())
  userId    String
  eventId   String
  createdAt DateTime @default(now())

  user  User  @relation(fields: [userId], references: [id])
  event Event @relation(fields: [eventId], references: [id])

  @@unique([userId, eventId])
}

// #region PUBLIC PLACE INTERACTIONS
model ReviewPublicPlace {
  id        String   @id @default(uuid())
  userId    String
  placeId   String
  rating    Float
  comment   String?
  image     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  user  User        @relation(fields: [userId], references: [id])
  place PublicPlace @relation(fields: [placeId], references: [id])

  @@unique([userId, placeId])
}

model LikePublicPlace {
  id        String   @id @default(uuid())
  userId    String
  placeId   String
  createdAt DateTime @default(now())

  user  User        @relation(fields: [userId], references: [id])
  place PublicPlace @relation(fields: [placeId], references: [id])

  @@unique([userId, placeId])
}

model PublicPlaceImpression {
  id        String   @id @default(uuid())
  placeId   String
  userId    String?
  createdAt DateTime @default(now())

  place PublicPlace @relation(fields: [placeId], references: [id])
  user  User?       @relation(fields: [userId], references: [id])

  @@index([placeId, createdAt])
}

// #region EVENTS & PUBLIC PLACES CORE

model Event {
  id          String      @id @default(uuid())
  venueId     String?
  name        String
  description String
  image       String?
  startAt     DateTime
  endAt       DateTime
  capacity    Int?
  status      EventStatus @default(UPCOMING)
  isActive    Boolean     @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  venue   Venue?        @relation(fields: [venueId], references: [id])
  reviews ReviewEvent[]
  likes   LikeEvent[]
}

model PublicPlace {
  id          String          @id @default(uuid())
  name        String
  type        PublicPlaceType
  address     String
  description String?
  latitude    Float?
  longitude   Float?
  image       String?
  gallery     String[]        @default([])
  isActive    Boolean         @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  reviews     ReviewPublicPlace[]
  likes       LikePublicPlace[]
  impressions PublicPlaceImpression[]
}

// #region NOTIFICATIONS
model Notification {
  id        String   @id @default(uuid())
  userId    String
  venueId   String?
  adminOnly Boolean? @default(false)
  title     String
  message   String
  type      String?
  image     String?
  isRead    Boolean  @default(false)
  isGlobal  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  user User @relation(fields: [userId], references: [id])
}

