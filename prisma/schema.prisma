generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

enum Role {
    CUSTOMER
    ADMIN
}

enum VenueType {
    BILLIARD
    MINI_SOCCER
    CAFE
    UNKNOWN
}

enum TableStatus {
    AVAILABLE
    BOOKED
    MAINTENANCE
}

enum BookingStatus {
    PENDING
    PAID
    CANCELLED
    COMPLETED
}

enum TransactionStatus {
    PENDING
    SUCCESS
    FAILED
    REFUNDED
    EXPIRED
}

enum TransactionType {
    TOPUP
    DEDUCTION
}

enum PointActivityType {
    REGISTER
    TOPUP
    BOOKING
    REVIEW
}

enum InvoiceStatus {
    PENDING
    PAID
    CANCELLED
    REFUNDED
}

model User {
    id        String   @id @default(uuid())
    name      String
    username  String?
    email     String   @unique
    password  String
    address  String?
    role      Role     @default(CUSTOMER)
    phone     String?
    photo     String?
    googleId  String?  @unique
    isVerified  Boolean @default(false)
    devices   Device[]
    createdAt DateTime @default(now())
    updatedAt DateTime @default(now()) @updatedAt

    // Relations
    bookings      Booking[]
    transactions  Transaction[]
    notifications Notification[]
    locations     LocationTracking[]
    logs          Log[]
    balance       UserBalance?
    points        Point[]
}

model UserBalance {
    id        String   @id @default(uuid())
    userId    String   @unique
    balance   Float    @default(0)
    updatedAt DateTime @default(now()) @updatedAt

    user User @relation(fields: [userId], references: [id])
}

model Venue {
    id          String     @id @default(uuid())
    name        String
    type        VenueType?
    address     String
    description String
    latitude    Float?
    longitude   Float?
    image       String?
    gallery     String[]   @default([])
    isActive    Boolean    @default(false)
    createdAt   DateTime   @default(now())
    updatedAt   DateTime   @default(now()) @updatedAt

    // Relations
    floors       Floor[]
    tables       Table[]
    menus        Menu[]
    bookings     Booking[]
    operationalHours OperationalHour[]
    invitation   InvitationKey?
    balance      VenueBalance?
    transactions Transaction[]
    owner        Owner?
}

model OperationalHour {
    id        String   @id @default(uuid())
    venueId   String
    dayOfWeek Int      
    opensAt   DateTime
    closesAt  DateTime

    venue Venue @relation(fields: [venueId], references: [id])
}

model Owner {
    id             String   @id @default(uuid())
    venueId        String?  @unique
    name           String
    email          String?
    address        String?
    identityNumber String?
    taxNumber      String?
    image          String?
    createdAt      DateTime @default(now())
    updatedAt      DateTime @default(now()) @updatedAt

    venue Venue? @relation(fields: [venueId], references: [id])
}

model VenueBalance {
    id        String   @id @default(uuid())
    venueId   String   @unique
    balance   Float    @default(0)
    updatedAt DateTime @default(now()) @updatedAt

    venue Venue @relation(fields: [venueId], references: [id])
}

model InvitationKey {
    id        String    @id @default(uuid())
    venueId   String    @unique
    key       String    @unique
    expiresAt DateTime?
    usedAt    DateTime?
    createdAt DateTime  @default(now())
    updatedAt DateTime  @default(now()) @updatedAt

    venue Venue @relation(fields: [venueId], references: [id])
}

model Floor {
    id      String  @id @default(uuid())
    name    String
    level   Int?
    venueId String
    venue   Venue   @relation(fields: [venueId], references: [id])
    tables  Table[]
}

model Table {
    id          String      @id @default(uuid())
    tableNumber Int
    floorId     String?
    venueId     String
    status      TableStatus @default(AVAILABLE)
    image       String?
    createdAt   DateTime    @default(now())
    updatedAt   DateTime    @default(now()) @updatedAt

    floor    Floor?    @relation(fields: [floorId], references: [id])
    venue    Venue     @relation(fields: [venueId], references: [id])
    bookings Booking[]
}

model Booking {
    id         String        @id @default(uuid())
    userId     String
    venueId    String
    tableId    String
    startTime  DateTime
    endTime    DateTime
    totalPrice Float
    status     BookingStatus @default(PENDING)
    createdAt  DateTime      @default(now())
    updatedAt  DateTime      @default(now()) @updatedAt

    user       User        @relation(fields: [userId], references: [id])
    venue      Venue       @relation(fields: [venueId], references: [id])
    table      Table       @relation(fields: [tableId], references: [id])
    orderItems OrderItem[]
    review     Review?
    invoice    Invoice?
}

model Menu {
    id          String   @id @default(uuid())
    venueId     String
    name        String
    price       Float
    category    String
    image       String?
    isAvailable Boolean  @default(true)
    createdAt   DateTime @default(now())
    updatedAt   DateTime @default(now()) @updatedAt

    venue      Venue       @relation(fields: [venueId], references: [id])
    orderItems OrderItem[]
}

model OrderItem {
    id        String   @id @default(uuid())
    bookingId String
    menuId    String
    quantity  Int
    subtotal  Float
    createdAt DateTime @default(now())
    updatedAt DateTime @default(now()) @updatedAt

    booking Booking @relation(fields: [bookingId], references: [id])
    menu    Menu    @relation(fields: [menuId], references: [id])
}

model Review {
    id        String   @id @default(uuid())
    bookingId String   @unique
    rating    Float
    comment   String?
    image     String?
    createdAt DateTime @default(now())
    updatedAt DateTime @default(now()) @updatedAt

    booking Booking @relation(fields: [bookingId], references: [id])
}

model Point {
    id        String            @id @default(uuid())
    userId    String
    activity  PointActivityType
    points    Int
    reference String? // id dari booking, transaction, dsb
    createdAt DateTime          @default(now())

    user User @relation(fields: [userId], references: [id])
}

model Invoice {
    id            String        @id @default(uuid())
    bookingId     String        @unique
    invoiceNumber String        @unique
    amount        Float
    status        InvoiceStatus @default(PENDING)
    paymentMethod String?
    issuedAt      DateTime      @default(now())
    paidAt        DateTime?
    cancelledAt   DateTime?
    createdAt     DateTime      @default(now())
    updatedAt     DateTime      @default(now()) @updatedAt

    booking Booking @relation(fields: [bookingId], references: [id])
}

model LocationTracking {
    id        String   @id @default(uuid())
    userId    String
    latitude  Float
    longitude Float
    updatedAt DateTime @default(now()) @updatedAt

    user User @relation(fields: [userId], references: [id])
}

model Notification {
    id        String   @id @default(uuid())
    userId    String
    venueId   String?           
    adminOnly Boolean? @default(false)
    title     String
    message   String
    type      String?
    image     String?
    isRead    Boolean  @default(false)
    isGlobal    Boolean  @default(false)
    createdAt DateTime @default(now())
    updatedAt DateTime @default(now()) @updatedAt

    user User @relation(fields: [userId], references: [id])
}

model Log {
    id          String   @id @default(uuid())
    userId      String?
    action      String
    description String?
    createdAt   DateTime @default(now())
    updatedAt   DateTime @default(now()) @updatedAt

    user User? @relation(fields: [userId], references: [id])
}

model Transaction {
    id          String             @id @default(uuid())
    userId      String?
    venueId     String?
    amount      Float
    type        TransactionType
    reference   String?
    vaNumber    String?
    qrisUrl     String?
    paymentCode String?
    bankCode    String?
    orderId     String?
    status      TransactionStatus? @default(PENDING)
    createdAt   DateTime           @default(now())
    updatedAt   DateTime           @default(now()) @updatedAt

    user  User?  @relation(fields: [userId], references: [id])
    venue Venue? @relation(fields: [venueId], references: [id])
}

model Device {
    id          String   @id @default(uuid())
    userId      String?
    token       String   @unique
    platform    String?
    osName      String?
    buildId     String?
    osVersion   String?
    deviceModel String?
    createdAt   DateTime @default(now())
    updatedAt   DateTime @updatedAt

    user User? @relation(fields: [userId], references: [id])
}
